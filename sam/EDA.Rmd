---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(network)

docs = read_csv('./data/docConnet.csv')


generate_Network = function(docs){
  source = docs %>% 
    distinct(Doc1) %>% 
    rename(label = Doc1) %>% mutate(type = "Attending")
  
  destination = docs %>% 
    distinct(Doc2,Connection) %>% 
    mutate(type = ifelse(Connection=='OperatingPhysician','Operating','Other')) %>% 
    rename(label = Doc2) %>% 
    select(label,type)
  
  nodes = full_join(source,destination, by=c('label','type')) %>% rowid_to_column("id") %>% drop_na()
  
  per_route = docs %>% 
    group_by(Doc1,Doc2) %>% 
    summarise(weight = sum(ClaimsFiled)) %>% 
    ungroup() %>% rowid_to_column()
  
  edges = per_route %>% 
    left_join(nodes, by=c('Doc1' = 'label')) %>% 
    rename(from=id)
  
  edges = edges %>% 
    left_join(nodes, by = c("Doc2" = 'label')) %>% 
    rename(to = id)
  
  edges = select(edges,from, to, weight)

  
  docNet <- network(edges, vertex.attr = nodes, 
                            matrix.type = "edgelist", ignore.eval = FALSE)

}
```
```{r}
data = filter(docs, State == 23)# %>% select(-X1)
data = data[complete.cases(data),]
generate_Network(data)
```

```{r}
edges
```

```{r}
library('network')

doc_net <- network(edges,  vertex.attr=nodes, matrix.type="edgelist", 
                loops=F, multiple=F, ignore.eval = F)

#detach('package:network')
library(ggraph)
library(igraph)

ggraph(doc_net) +
  geom_edge_fan(color="gray50", width=0.8, alpha=0.5) + 
  geom_node_point() +
  theme_bw() # add nodes to the plot

```
```{r}
ggraph(doc_net) +
  geom_edge_arc(color="gray", curvature=0.3, aes(size=weight)) +            
  geom_node_point(color="orange") +     
  geom_node_text(aes(label = label), size=2, color="black", repel=T) +
  theme_void()
```

```{r}
par(mar=c(0,0,0,0))

render.d3movie(doc_net, usearrows = F, displaylabels = F, bg="#111111", 
       vertex.border="#ffffff", 
       #vertex.col =  net3 %v% "col",
       #vertex.cex = (net3 %v% "audience.size")/8, 
       edge.lwd = (net3 %e% "weight")/3, 
       edge.col = '#55555599',
       vertex.tooltip = paste("<b>Name:</b>", (net3 %v% 'label')), 
                              #"<br>",
                              #"<b>Type:</b>", (net3 %v% 'type.label')),
       edge.tooltip = paste("<b>Connection to Source:</b>", (net3 %e% 'Connection'), "<br>", 
                            "<b>Number of Claims Filed:</b>", (net3 %e% "weight" ) ),
       launchBrowser=F, filename="Doc-Network.html")
```



```{r}
save(nodes, file = "nodes.RData")
save(edges, file = "edges.RData")
```


```{r}
library(network)

routes_network <- network(edges, vertex.attr = nodes, 
                          matrix.type = "edgelist", ignore.eval = FALSE)
```
```{r}
plot(routes_network, vertex.cex = 3)
plot(routes_network, vertex.cex = 3, mode = "circle")

```
```{r}
detach(package:network)
rm(routes_network)
library(igraph)
```

```{r}
routes_igraph <- graph_from_data_frame(d = edges, vertices = nodes, directed = TRUE)
```
```{r}
plot(routes_igraph, edge.arrow.size = 0.2)
plot(routes_igraph, layout = layout_with_graphopt, edge.arrow.size = 0.2)
```

```{r}
library(tidygraph)
library(ggraph)
```
```{r}
routes_tidy <- tbl_graph(nodes = nodes, edges = edges, directed = TRUE)
```

```{r}
routes_tidy
```

```{r}
routes_tidy %>% 
  activate(edges) %>% 
  arrange(desc(weight))
```
```{r}
ggraph(routes_tidy, layout = 'graphopt') + 
  geom_node_point() + 
  geom_edge_link(aes(width=weight), alpha=0.8) +
  scale_edge_width(range=c(0.1,2)) +
  geom_node_text(aes(label=label), repel=TRUE) +
  labs(edge_width = "Letters") +
  theme_graph()

ggraph(routes_igraph, layout = "linear") + 
  geom_edge_arc(aes(width = weight), alpha = 0.8) + 
  scale_edge_width(range = c(0.2, 2)) +
  geom_node_text(aes(label = label)) +
  labs(edge_width = "Letters") +
  theme_graph()

```
```{r}
library(visNetwork)
library(networkD3)

visNetwork(nodes,edges)
```

```{r}
edges = mutate(edges, width = weight/5 + 1)

visNetwork(nodes,edges) %>% 
  visIgraphLayout(layout = "layout_with_fr") %>% 
  visEdges(arrows="middle")
```

```{r}
nodes_d3 <- mutate(nodes, id = id - 1)
edges_d3 <- mutate(edges, from = from - 1, to = to - 1)
```

```{r}
forceNetwork(Links = edges_d3, Nodes = nodes_d3, Source = "from", Target = "to", 
             NodeID = "label", Group = "id", Value = "weight", 
             opacity = 1, fontSize = 16, zoom = TRUE)
```
```{r}
sankeyNetwork(Links = edges_d3, Nodes = nodes_d3, Source = "from", Target = "to", 
              NodeID = "label", Value = "weight", fontSize = 16, unit = "Letter(s)")
```
```{r}
netmat1 <- rbind(c(0,1,1,0,0), c(0,0,1,1,0), c(0,1,0,0,0), c(0,0,0,0,0), c(0,0,1,0,0))
rownames(netmat1) <- c("A","B","C","D","E") 
colnames(netmat1) <- c("A","B","C","D","E")
net1 <- network(netmat1,matrix.type="adjacency") 
class(net1)
```

```{r}
gplot(net1, vertex.col=2, displaylabels=TRUE)
```

```{r}
data = read_csv('./data/combinedData.csv')
#target = read_csv('./data/combinedTarget.csv')
```

```{r}
library(Hmisc)
library(psych)
data_summary = data %>% select_if(is.numeric) %>% psych::describe()
```

```{r}
data_summary %>% mutate(n = abs(n-693603))
```
```{r}
library(statnet)
as.matrix(net1, matrix.type='edgelist')
```

```{r}
set.vertex.attribute(net1, "gender", c("F","F","M","F","M"))
net1 %v% "alldeg" = degree(net1)
list.vertex.attributes(net1)

get.vertex.attribute(net1, "alldeg")

set.edge.attribute(net1, "rndval", runif(network.size(net1),0,1))

netval1 <- rbind(c(0,2,3,0,0), c(0,0,3,1,0), c(0,1,0,0,0), c(0,0,0,0,0), c(0,0,2,0,0))
netval1 <- network(netval1,matrix.type="adjacency", ignore.eval=FALSE,names.eval="like")
```

